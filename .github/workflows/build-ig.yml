name: Build and Publish IG

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

permissions:
  actions: write
  contents: write
  pull-requests: write
  issues: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      SUSHI_INPUT_DIR: .

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Pull Docker image
        run: docker pull ghcr.io/gefyra/ig-publisher-with-snapshot-support:latest

      - name: Build IG inside container (deps + sushi + publisher w/ snapshots)
        run: |
          docker run --rm \
            -u "$(id -u):$(id -g)" \
            -v "$PWD":/workspace \
            -w /workspace \
            -e HOME=/tmp \
            ghcr.io/gefyra/ig-publisher-with-snapshot-support:latest \
            bash -lc 'set -euo pipefail
              # 1) Download FHIR dependencies defined in sushi-config.yaml
              #    (adjust path if your sushi-config.yaml is elsewhere)
              fhir-pkg-tool --sushi-deps-file "./sushi-config.yaml"

              # 2) Generate FHIR JSON from FSH
              sushi .

              # 3) Build IG with the publisher shipped in the image (snapshot-support)
              igpublisher -ig ig.ini -no-sushi
            '

      - name: Record branch metadata for Pages cleanup
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        run: |
          echo "${GITHUB_REF_NAME}" > "${{ env.SUSHI_INPUT_DIR }}/output/.branch-name"

      - name: Publish branch output to GitHub Pages
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        shell: bash
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail

          remote_url="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"

          git config --global user.name "${GIT_AUTHOR_NAME}"
          git config --global user.email "${GIT_AUTHOR_EMAIL}"

          rm -rf gh-pages

          if git ls-remote --heads "${remote_url}" gh-pages | grep -q "."; then
            git clone --depth 1 --branch gh-pages "${remote_url}" gh-pages
          else
            git clone "${remote_url}" gh-pages
            cd gh-pages
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
            touch .nojekyll
            git add .nojekyll
            git commit -m "chore: initialize gh-pages"
            git push --set-upstream origin gh-pages
            cd ..
          fi

          branch_dir="gh-pages/${GITHUB_REF_NAME}"
          rm -rf "${branch_dir}"
          mkdir -p "${branch_dir}"
          cp -R "${{ env.SUSHI_INPUT_DIR }}/output/." "${branch_dir}/"

          cd gh-pages
          git add --all
          if git diff --cached --quiet; then
            echo "No updates to publish."
            exit 0
          fi
          git commit -m "chore: update ${GITHUB_REF_NAME} pages"
          git push origin gh-pages

      - name: Announce published URL
        id: announce_url
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        shell: bash
        run: |
          set -eu
          owner="${GITHUB_REPOSITORY_OWNER}"
          repo="${GITHUB_REPOSITORY#*/}"
          branch="${GITHUB_REF_NAME}"
          url="https://${owner}.github.io/${repo}/${branch}/"
          printf '### Deployment\n[Open published IG for branch `%s`](%s)\n' "${branch}" "${url}" >> "${GITHUB_STEP_SUMMARY}"
          echo "published_url=${url}" >> "${GITHUB_OUTPUT}"

      - name: Upsert PR comment with published URL
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/')
        uses: actions/github-script@v7
        env:
          BRANCH_NAME: ${{ github.ref_name }}
          PUBLISHED_URL: ${{ steps.announce_url.outputs.published_url }}
        with:
          script: |
            const { owner, repo } = context.repo;
            const branch = process.env.BRANCH_NAME;
            const url = process.env.PUBLISHED_URL;

            const marker = `<!-- ig-publish-url -->`;
            const body = `${marker}
            ### Deployment
            [Open published IG for branch \`${branch}\`](${url})`;

            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', per_page: 100 });
            const pr = prs.find(p => p.head && p.head.ref === branch);
            if (!pr) return;

            const { data: comments } = await github.rest.issues.listComments({ owner, repo, issue_number: pr.number, per_page: 100 });
            const existing = comments.find(c => typeof c.body === 'string' && c.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({ owner, repo, comment_id: existing.id, body });
            } else {
              await github.rest.issues.createComment({ owner, repo, issue_number: pr.number, body });
            }
            