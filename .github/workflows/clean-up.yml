name: Cleanup Branch Pages

on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Check gh-pages branch
        id: gh-pages
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.repos.getBranch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: 'gh-pages',
              });
              core.setOutput('exists', 'true');
            } catch (error) {
              if (error.status === 404) {
                core.warning('gh-pages branch does not exist yet. Nothing to clean.');
                core.setOutput('exists', 'false');
              } else {
                throw error;
              }
            }

      - name: Checkout gh-pages
        if: steps.gh-pages.outputs.exists == 'true'
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 0

      - name: Prune deleted branch directories
        if: steps.gh-pages.outputs.exists == 'true'
        shell: bash
        env:
          REPO: ${{ github.repository }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          set -euo pipefail

          if [ -z "$(git ls-files)" ]; then
            echo "gh-pages branch is empty. Nothing to clean."
            exit 0
          fi

          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"

          shopt -s globstar nullglob
          removed=0

          for metadata in **/.branch-name; do
            branch=$(cat "$metadata" | tr -d '\r')
            dir=$(dirname "$metadata")
            dir_no_prefix=${dir#./}

            if [ -z "$branch" ]; then
              echo "Skipping $dir because branch marker is empty."
              continue
            fi

            # Only protect repo root / invalid dirs
            if [ -z "$dir_no_prefix" ] || [ "$dir_no_prefix" = "." ]; then
              echo "Preserving $dir; skipping cleanup."
              continue
            fi

            if git ls-remote --heads origin "$branch" | grep -q "."; then
              echo "Branch '$branch' still exists. Keeping $dir."
              continue
            fi

            echo "Branch '$branch' no longer exists. Removing $dir."
            rm -rf "$dir"
            removed=1
          done

          if [ "$removed" -eq 0 ]; then
            echo "No stale branch directories found."
            exit 0
          fi

          find . -mindepth 1 -type d -empty -delete

          git add --all
          if git diff --cached --quiet; then
            echo "No changes to commit after cleanup."
            exit 0
          fi

          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git commit -m "chore: remove Pages for deleted branches"
          git push origin gh-pages
          